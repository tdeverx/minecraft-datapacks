name: build-package.yml

on:
  push:
    branches:
      - main
    tags:
      - v*
      - Release
      - Pre-Release
      - Build
      - Test
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      tag_prefix: ${{ steps.check.outputs.tag_prefix }}
      tags_present: ${{ steps.check.outputs.tags_present }}
      version_number: ${{ steps.check.outputs.version_number }}
      project_name: ${{ steps.check.outputs.project_name }}
    steps:
      - uses: actions/checkout@v3

      -  name: Extract tags
         run: |
          COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
          echo "COMMIT_MESSAGE=${COMMIT_MESSAGE}"
          if [[ "${COMMIT_MESSAGE}" =~ ^(Release|Pre-Release|Build|Test):\ (.+)\ v(.+)$ ]]; then
             TAG_PREFIX=${BASH_REMATCH[1]}
             TAG_PREFIX=${TAG_PREFIX,,}
             echo "tag_prefix=${TAG_PREFIX}" >> $GITHUB_OUTPUT
             echo "version_number=${VERSION_NUMBER=${BASH_REMATCH[3]}}" >> $GITHUB_OUTPUT
             PROJECT_NAME="${BASH_REMATCH[2]}"
             PROJECT_NAME=${PROJECT_NAME,,}
             PROJECT_NAME=${PROJECT_NAME// /-}
             echo "project_name=${PROJECT_NAME}" >> $GITHUB_OUTPUT
          else
            echo "Invalid commit message format"
            exit 1
          fi
           
      -   name: Check tags
          run: |
            TAG_PREFIX="${TAG_PREFIX}"
            if [[ "${TAG_PREFIX}" == "release" || "${TAG_PREFIX}" == "pre-release" ]]; then
              echo "::set-output name=tags_present::TRUE"
              echo "tags_present=TRUE" >> $GITHUB_OUTPUT
            else
              echo "tags_present=FALSE" >> $GITHUB_OUTPUT
              echo "Tags are not present in the commit message"
              exit 1
            fi

  build:
    runs-on: ubuntu-latest
    if: success()
    needs: check
    steps:
      - uses: actions/checkout@v3

      - name: Archive Release
        uses: thedoctor0/zip-release@0.7.1
        with:
          path: ${{ needs.check.outputs.project_name }}/
          type: zip
          filename: ${{ needs.check.outputs.project_name }}-${{ needs.check.outputs.tag_prefix }}-${{ needs.check.outputs.version_number }}
          exclusions: '*.git* /*node_modules/* .editorconfig'

  upload:
    runs-on: ubuntu-latest
    if: success()
    needs: build
    steps:
      - uses: actions/checkout@v3

      - name: Upload Artifact
        if: ${{ needs.check.outputs.tags_present == 'true' }}
        uses: actions/upload-artifact@v2
        with:
          name: release-artifact
          path: ${{ needs.check.outputs.project_name }}-${{ needs.check.outputs.tag_prefix }}-${{ needs.check.outputs.version_number }}
